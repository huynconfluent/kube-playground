# kube-playground

## Goal
Create a quick and easy local kubernetes deployment for use with deploying and testing various Operator/CFK configurations.
Focus will be using k3d for the local kubernetes deployment.

> [!NOTE]
> This has only been tested on MacOS. So your mileage may vary.

## Prerequisites
- k3d
- docker
- kubectl
- helm
- [docker-mac-net-connect](https://github.com/chipmk/docker-mac-net-connect) *For MacOS based deployments

## TODO
- [x] Create initial k3d deployment helper
- [x] Create automated openldap deployment
- [x] Create automated keycloak deployment
- [x] Create automated CFK deployment
- [x] Add auto generated ssl helper scripts
- [ ] Add auto generated credential helper scripts

## Install k3d
This assumes you already have k3d installed.
Follow the installation instruction on [k3d.io](https://k3d.io)

For Mac (Using Homebrew)
```
brew install k3d
```

## Install the docker-mac-net-connect
This is used to provide a networking path to docker containers in MacOS by creating a `utun` network interface and then adds a route automatically.
```
sudo brew install chipmk/tap/docker-mac-net-connect
```

Start|Stop|Restart
```
sudo brew services start|stop|restart chipmk/tap/docker-mac-net-connect
```

## Prerequisites
Make sure you make a copy of the `.env.example` file and configure it for automatic deployment of extra
```
cp .env.example .env
```

## Usage
You can deploy base k3s environment using the following command
```
export BASE_DIR=$(pwd)
./start.sh 
```

You can automate deployment of LDAP or IDP

You can also automate CFK deployment by providing either the CFK Helm version or CFK Operator Image Version
```
export BASE_DIR=$(pwd)
CFK_HELM_VERSION=2.11.1 ./start.sh
```
or
```
export BASE_DIR=$(pwd)
CFK_IMAGE_VERSION=0.1193.34 ./start.sh
```

### Generate SSL files and scripts
You can automate the creation of SSL files (PEM and jks), this is opinionated and will generate SSL certificates for the following components
```
connect
controlcenter
kafka
kafkarestproxy
keycloak
kraftcontroller
ksqldb
openldap
replicator
schemaregistry
zookeeper
```
This will also generate shell scripts which you can then use to create kubernetes secret. These will be found in `generated/ssl/cmd`

You can then just run the shell script to create said secret
```
cat generated/ssl/cmd/kraftcontroller/create-tls-kraftcontroller-secret.sh
#!/bin/sh
kubectl -n confluent create secret generic tls-kraftcontroller --from-file=fullchain.pem=/Users/huy.nguyen/projects/github/kube-playground/generated/ssl/component/certs/kraftcontroller-fullchain.pem --from-file=cacerts.pem=/Users/huy.nguyen/projects/github/kube-playground/generated/ssl/intermediate_ca/certs/fullchain.pem --from-file=privkey.pem=/Users/huy.nguyen/projects/github/kube-playground/generated/ssl/component/private/kraftcontroller.key
```
As you can see the `kubectl` command is autogenerated based on predetermined paths and namespace set by the `.env` file. When executed it should be successful.
> [!WARNING]
> Please always review shell scripts before executing!
```
source generated/ssl/cmd/kraftcontroller/create-tls-kraftcontroller-secret.sh
secret/tls-kraftcontroller created
```
This will allow you to re-create the kubernetes secret on new cluster deployment without having to re-generate ssl files, so long as they exist.
