# kube-playground

## Goal

Create a quick and easy local kubernetes deployment for use with deploying and testing various Operator/CFK configurations.
Focus will be using k3d for the local kubernetes deployment.

> [!NOTE]
> This has only been tested on MacOS. So your mileage may vary.

## Prerequisites

- k3d
- docker
- kubectl
- helm
- jq
- cfssl
- [docker-mac-net-connect](https://github.com/chipmk/docker-mac-net-connect) \*For MacOS based deployments

## TODO

- [x] Create initial k3d deployment helper
- [x] Create automated openldap deployment
- [x] Create automated keycloak deployment
- [x] Create automated CFK deployment
- [x] Add auto generated ssl helper scripts
- [ ] Add auto generated credential helper scripts
- [x] Add workflow for using multipass vm for k3d instead of local k3d deployment
- [ ] Add workflow for Openshift connection
- [ ] Create CR Generator
- [ ] Add Terraform workflow
  - [ ] AWS (EKS)
  - [ ] ~~AWS (ROSA) needs subscription~~
  - [ ] Azure (AKS)
  - [ ] Azure (Openshift)
- [ ] Add REST helper scripts (get Bearer Token)
- [x] Add Flink Deployment
- [ ] ~~Add USM deployment~~
- [ ] Add setup for Confluent Private Cloud Gateway

## Default Kubernetes Cluster

The default behavior is to spin up a Kubernetes cluster using k3d, this must be installed ahead of time.
Alternatie approach is to use multipass and spin up k3d within the multipass VM.

## Option 1: Install k3d

This assumes you already have k3d installed.
Follow the installation instruction on [k3d.io](https://k3d.io)

For Mac (Using Homebrew)

```
brew install k3d
```

## Option 2: Using Multipass VM

Start with passing `multipass` argument

```
CFK_HELM_VERSION=2.11.0 ./start.sh multipass
```

## Install the docker-mac-net-connect

This is used to provide a networking path to docker containers in MacOS by creating a `utun` network interface and then adds a route automatically.

```
sudo brew install chipmk/tap/docker-mac-net-connect
```

Start|Stop|Restart

```
sudo brew services start|stop|restart chipmk/tap/docker-mac-net-connect
```

### Issue with newer Docker Desktop Versions

There's an issue I encountered with newer versions of Docker Desktop as noted in this [Github Issue](https://github.com/chipmk/docker-mac-net-connect/issues/62) so it'd be best to start docker-mac-net-connect with

```
sudo env DOCKER_API_VERSION=1.44 docker-mac-net-connect
```

## Prerequisites

Make sure you make a copy of the `.env.example` file and configure it for defaults

```
cp .env.example .env
```

## Usage

You can deploy base k3s environment using the following command

```
export BASE_DIR=$(pwd)
./start.sh
```

You can automate deployment of LDAP or IDP

You can also automate CFK deployment by providing either the CFK Helm version or CFK Operator Image Version

```
export BASE_DIR=$(pwd)
CFK_HELM_VERSION=2.11.1 ./start.sh
```

or

```
export BASE_DIR=$(pwd)
CFK_IMAGE_VERSION=0.1193.34 ./start.sh
```

### Generate SSL files and scripts

You can automate the creation of SSL files (PEM and jks), this is opinionated and will generate SSL certificates for the following components

```
connect
controlcenter
kafka
kafkarestproxy
keycloak
kraftcontroller
ksqldb
openldap
replicator
schemaregistry
zookeeper
```

This will also generate shell scripts which you can then use to create kubernetes secret. These will be found in `generated/ssl/cmd`

You can then just run the shell script to create said secret

```
cat generated/ssl/cmd/kraftcontroller/create-tls-kraftcontroller-secret.sh
#!/bin/sh
kubectl -n confluent create secret generic tls-kraftcontroller --from-file=fullchain.pem=/Users/huy.nguyen/projects/github/kube-playground/generated/ssl/component/certs/kraftcontroller-fullchain.pem --from-file=cacerts.pem=/Users/huy.nguyen/projects/github/kube-playground/generated/ssl/intermediate_ca/certs/fullchain.pem --from-file=privkey.pem=/Users/huy.nguyen/projects/github/kube-playground/generated/ssl/component/private/kraftcontroller.key
```

As you can see the `kubectl` command is autogenerated based on predetermined paths and namespace set by the `.env` file. When executed it should be successful.

> [!WARNING]
> Please always review shell scripts before executing!

```
source generated/ssl/cmd/kraftcontroller/create-tls-kraftcontroller-secret.sh
secret/tls-kraftcontroller created
```

This will allow you to re-create the kubernetes secret on new cluster deployment without having to re-generate ssl files, so long as they exist.

## Run CFK Version Extractor

While kube-playground stores a manual copy of CFK Version to Image Tag mapping, it may not always be up to date. You can use the following script to manually generate a new mapping combining default mapping with what we pull from [Confluent Documentation](https://docs.confluent.io/operator/current/co-plan.html#co-long-image-tags) thus creating a brand new mapping.

```
export BASE_DIR=$(pwd)
./scripts/helper/cfk-version-extractor.sh
```

If the version differs, it would be advised to replace the old mapping at `$BASE_DIR/configs/cfk/version_mapping.json` with the new file from `$BASE_DIR/generated/cfk/version_mapping.json` until kube-playground is updated with this new copy.

## Deploy LDAP

By default OpenLDAP will be deployed to the `identity` namespace. You can modify this via the `.env` file.

```
LDAP_NAMESPACE="identity"
```

When running `start.sh` you can specify a flag to auto-deploy OpenLDAP.

```
./start.sh -e ldap
```

Alternatively if you need to deploy it after the fact you can do so with

```
source ./scripts/helper/deploy-ldap.sh
```

## Deploy IDP

By default Keycloak is the IDP that will be deployed into the `identity` namespace. You can modify this via the `.env` file.

```
IDP_NAMESPACE="identity"
```

When running `start.sh` you can specify a flag to auto-deploy Keycloak

```
./start.sh -e idp
```

Alternatively if you need to deploy it after the fact you can do so with

```
source ./scripts/helper/deploy-idp.sh
```
